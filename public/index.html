<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<h2>Hello OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
  <video id="videoInput" width="320" height="240"></video>
  <canvas id="canvasFrame" width="320" height="240" style="display: none;"></canvas>
  <canvas id="canvasOutput" width="320" height="240"></canvas>
  <canvas id="canvasOutput2" width="320" height="240"></canvas>

</div>
<script src="opencv.js" type="text/javascript"></script>

<script type="text/javascript">
let video = document.getElementById("videoInput"); // video is the id of video tag
navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(function(stream) {
        video.srcObject = stream;
        video.play();
    })
    .catch(function(err) {
        console.log("An error occured! " + err);
    });
let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
let dst = new cv.Mat(video.height, video.width, cv.CV_8UC3);
let dst3 = new cv.Mat(video.height, video.width, cv.CV_8UC3);
let dst4 = new cv.Mat(video.height, video.width, cv.CV_8UC3);
let contours = new cv.MatVector();
let hierarchy = new cv.Mat();
let low =  new cv.Mat(dst3.rows, dst3.cols, dst3.type(), [30, 40, 40, 0]);
let high =  new cv.Mat(dst3.rows, dst3.cols, dst3.type(), [70, 250, 250, 255]);
let color = new cv.Scalar(255, 255, 255);

let M = cv.Mat.ones(11, 11, cv.CV_8U);

let dst2 = new cv.Mat(video.height, video.width, cv.CV_8U);

let cap = new cv.VideoCapture(video);
let canvasFrame = document.getElementById("canvasFrame"); // canvasFrame is the id of <canvas>
let context = canvasFrame.getContext("2d");

const FPS = 30;
function processVideo() {
  try {
    let begin = Date.now();
    context.drawImage(video, 0, 0, video.width, video.height);
    let src2 = cv.imread('canvasFrame');

let ksize = new cv.Size(4, 4);
let anchor = new cv.Point(-1, -1);
// You can try more different parameters
//cv.blur(src2, src2, ksize, anchor, cv.BORDER_DEFAULT);
    cv.cvtColor(src2, dst, cv.COLOR_RGBA2BGR);
    cv.cvtColor(dst, dst3, cv.COLOR_BGR2HSV);
    // cv.Canny(src2, dst2, 200, 300, 3, true);

    //let M = cv.Mat.ones(3, 3, cv.CV_8U);

    // cv.findContours(dst2, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
    // let cnt = contours.get(0);
    // if (cnt) {
    //     let color = new cv.Scalar(255,0,0);
    //     cv.drawContours(dst, contours, 0, color, 1, 8, hierarchy, 0)
    //     let M = cv.moments(cnt, false);
    //     let cx = Math.round(M.m10/M.m00);
    //     let cy = Math.round(M.m01/M.m00);
    // let center = new cv.Point(cx, cy);
    //     cv.circle(dst2, center, 5, color)
    // }

    // let low = new cv.Mat(dst.rows, dst.cols, dst.type(), [0, 0, 0, 0]);
    // let high = new cv.Mat(dst.rows, dst.cols, dst.type(), [255, 255, 255, 255]);
    // console.log(dst3.data)
    //Shape - triangle
    //Colour - green
    //Size - decent to large
    // let low =  new cv.Mat(dst3.rows, dst3.cols, dst3.type(), [53, 40, 40, 0]);
    // let high =  new cv.Mat(dst3.rows, dst3.cols, dst3.type(), [65, 250, 250, 255]);
    // // console.log(high.data)
    cv.cvtColor(high, dst4, cv.COLOR_HSV2BGR)
    // // console.log(dst3.data)
    cv.cvtColor(dst4, dst, cv.COLOR_BGR2RGBA)

// COLOR_HSV2BGR
// COLOR_BGR2RGBA
    cv.inRange(dst3, low, high, dst2)
    //cv.blur(dst2, dst2, ksize, anchor, cv.BORDER_DEFAULT);
    // let contours = new cv.MatVector();
    // let hierarchy = new cv.Mat();
    // let M = cv.Mat.ones(7, 7, cv.CV_8U);
    // You can try more different parameters
    //cv.morphologyEx(dst2, dst2, cv.MORPH_GRADIENT, M);
// You can try more different parameters


//cv.dilate(dst2, dst2, M, anchor, 1, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue());
    //cv.blur(dst2, dst2, ksize, anchor, cv.BORDER_DEFAULT);
    //cv.erode(dst2, dst2, M, anchor, 1, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue());
  //  cv.blur(dst2, dst2, ksize, anchor, cv.BORDER_DEFAULT);

 
cv.morphologyEx(dst2, dst2, cv.MORPH_OPEN, M);
    cv.findContours(dst2, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
    let cnt = contours.get(0);
    if (cnt) {
        cv.drawContours(dst2, contours, -1, color, 1, 8, hierarchy, 0)
        let M = cv.moments(cnt, false);
        let cx = Math.round(M.m10/M.m00);
        let cy = Math.round(M.m01/M.m00);
        let center = new cv.Point(cx, cy);
        cv.circle(dst2, center, 5, color)
        if (cx > 160) {
            let l2 = new cv.Point(320, cy);
            cv.line(dst2, center, l2, color, 3, 3)
        } else {
            let l2 = new cv.Point(0, cy);
            cv.line(dst2, center, l2, color, 3, 3)
        }
    }
    // You can try more different parameters
    // let M = cv.moments(cnt, false);
    // let cx = M.m10/M.m00;
    // let cy = M.m01/M.m00;
    // cv.circle(dst2, (cx, cy), 5, (255, 255, 255), -1)
    // contours.delete(); hierarchy.delete();


    //dst = cv.bitwise_and(src2, src2, dst2)
    cv.imshow("canvasOutput", dst); // canvasOutput is the id of another <canvas>;
    cv.imshow("canvasOutput2", dst2);
    // schedule next one.
    let delay = 1000/FPS - (Date.now() - begin);
    setTimeout(processVideo, delay);
  } catch (err) {
    console.log(err);
  }
};

// schedule the first one.
setTimeout(processVideo, 0);
</script>
</body>
</html>